version: '3.9'

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - app-network
    volumes:
      # Optional: mount for development hot-reload
      # - .:/app
      # - /app/node_modules
      # - /app/.next
    depends_on:
      - supabase

  supabase:
    image: supabase/supabase:latest
    ports:
      - "5432:5432"
      - "3001:3000"
      - "54321:54321"
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET environment variable is required}
      JWT_EXPIRY: 3600
    restart: unless-stopped
    networks:
      - app-network
    volumes:
      - supabase_data:/bitnami/postgresql
    # Note: For a full Supabase setup, you would need to configure additional services
    # This is simplified - use official Supabase docker-compose for development

networks:
  app-network:
    driver: bridge

volumes:
  supabase_data:
    driver: local
